# 排课系统需求文档 (V2.0 - 架构升级版)

## 1. 项目背景与目标

### 1.1 项目背景
（同V1.0）

### 1.2 项目目标
（同V1.0，核心目标不变，但实现方式将更健壮和灵活）

---

## 2. 核心理念变更 (V2.0 核心)

V2.0版本将对核心业务流程和数据模型进行架构级升级，从原有的“以班级为中心”的模式，转变为更灵活、更健壮的“**以学生报名为中心**”的模式，并确保所有历史数据的**不可变性**。

*   **核心流程**: `定义课程产品` -> `学生购买/报名` -> `组合报名记录进行排课` -> `课后考勤与课耗`。
*   **数据原则**: 所有已发生的课程安排 (`课表条目`) 均作为**历史快照**独立存储，不再与课程定义动态关联，确保历史数据的绝对准确性。

---

## 3. 用户角色与职责

（同V1.0）

---

## 4. 核心功能需求 (V2.0)

### 4.1 基础信息管理 (重构)

- [ ] **数据字典管理 (新增)**:
  - [ ] 提供一个统一的管理界面，用于管理系统中所有可配置的选项。
  - [ ] 支持按“组别”对字典项进行分类（如：`年级`、`科目`、`课程类型`、`学生标签组`）。
  - [ ] 管理员可在此页面自由增、删、改、查所有基础选项，无需修改代码。
  - [ ] **取代**原有的独立的 `年级管理`、`科目管理`、`标签管理`。

- [ ] **课程产品管理 (新增)**:
  - [ ] 添加/编辑/停用标准化的课程产品。
  - [ ] **核心属性**:
    - `产品名称` (如: "高一数学辅导")
    - `关联科目` (来自数据字典)
    - `关联年级` (来自数据字典)
    - `课程类型` (来自数据字典, 如: '一对一', '小班')

- [ ] **教师管理**: (基本不变)
  - [ ] 核心属性中的“可教科目”和“可教年级”将关联到数据字典。

- [ ] **教室管理**: (基本不变)

- [ ] **学生管理**: (基本不变)
  - [ ] “学生标签”将关联到数据字典。

### 4.2 报名与分组管理 (全新)

- [ ] **学生报名管理 (核心)**:
  - [ ] **功能**: 记录学生对课程的购买/报名行为。
  - [ ] **核心属性**:
    - 关联`学生`。
    - 关联`课程产品`。
    - `总购买课时`。
    - `已消耗课时` (系统根据考勤自动计算)。
    - `报名状态` (如: 正常, 已暂停, 已完结, 已退款)。

- [ ] **学习小组管理 (新增)**:
  - [ ] **功能**: 允许管理员将多个独立的“报名记录”打包成一个固定的“学习小组”，以极大提升重复排课的效率。
  - [ ] **核心属性**:
    - `小组名称` (如: "高一数学A组")。
    - 关联多个`报名记录`。
  - [ ] **智能推荐**: 创建小组并添加第一个成员后，系统应能根据该成员的课程和学生标签，**智能推荐**其他合适的报名记录加入小组。

### 4.3 智能排课 (重构)

- [ ] **排课入口**:
  - [ ] 管理员在日历视图上通过**框选时间**来发起排课。
- [ ] **排课模式**:
  - [ ] **按学习小组排课 (高效模式)**:
    - 选择一个已创建的“学习小组”。
    - 系统自动带入该小组的所有学生、科目、年级信息。
    - 管理员只需选择**实际上课教师**和**教室**即可完成排课。
  - [ ] **按报名记录排课 (灵活模式)**:
    - 手动选择一个或多个独立的“报名记录”。
    - 系统自动带入学生和课程信息。
    - 管理员选择教师和教室完成排课。
- [ ] **冲突检测**: (逻辑不变，但检测对象变为 `ScheduleEntry` 的直接属性)
  - [ ] 实时检测教师、教室、以及所有参与学生的档期冲突。
- [ ] **历史快照**:
  - [ ] 排课成功后，系统将创建一个独立的 `课表条目 (ScheduleEntry)` 记录。
  - [ ] 该记录将**冗余存储**所有关键信息（教师姓名、教室名称、科目、年级、课程名、学生列表），确保历史记录不因未来基础数据的变动而改变。

### 4.4 课表调整与管理

- [ ] **调课/代课**: (逻辑不变) 支持管理员修改已安排课程的时间、教室或**实际授课教师**。
- [ ] **删除课程**: (逻辑不变) 支持单节删除和批量删除。

### 4.5 学生考勤管理 (新增)

- [ ] **手动记勤**: 允许教师或管理员为已完成的课程，手动修改其中每个学生的出勤状态。
- [ ] **默认出勤**: 所有新安排的课程，学生的考勤状态默认为“出勤”。
- [ ] **课时联动**: 学生的考勤状态将直接影响其对应“报名记录”的“已消耗课时”的计算。

### 4.6 课表展示与查询

- [ ] (基本不变) 所有展示和筛选逻辑将基于新的 `ScheduleEntry` 快照数据。

---

## 5. 非功能性需求

（同V1.0）

---

## 6. 未来扩展功能 (V2.0 基础之上)

- [ ] **课时统计与费用结算**: 基于 `Enrollment` 模型的课时数据，实现财务统计。
- [ ] **教师薪酬统计**: 基于 `ScheduleEntry` 的教师数据，实现工作量统计。
- [ ] 学生请假与补课流程管理。
- [ ] 家长/学生在线选课、约课功能。
- [ ] 自动上课提醒功能。
